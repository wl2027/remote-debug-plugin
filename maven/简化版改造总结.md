# âœ… ç®€åŒ–ç‰ˆæ”¹é€ å®Œæˆæ€»ç»“

## ğŸ“‹ æ”¹é€ ç›®æ ‡

1. **ç§»é™¤è®¤è¯æœºåˆ¶** - è®©ä»£ç æ›´ç®€æ´é«˜æ•ˆ
2. **é€šè¿‡å®Œæ•´æµ‹è¯•** - éªŒè¯ JDI â†” Client â†” Server â†” App å…¨æµç¨‹

## âœ… å®Œæˆæƒ…å†µ

### 1. ä»£ç ç®€åŒ–

#### ç§»é™¤çš„æ–‡ä»¶
- âŒ `AuthenticationManager.java` (180 è¡Œ)
- âŒ `TokenGenerator.java` (80 è¡Œ)

#### ç®€åŒ–çš„ä»£ç 
- âœ… `WebSocketDebugProxyServer.java` - ç§»é™¤æ‰€æœ‰è®¤è¯é€»è¾‘
- âœ… `WebSocketDebugProxyClient.java` - ç§»é™¤ Token ç›¸å…³ä»£ç 
- âœ… `pom.xml` (Server) - ç§»é™¤ JWT ä¾èµ–
- âœ… `pom.xml` (Client) - ä¿æŒæœ€å°ä¾èµ–

**ä»£ç å‡å°‘**: çº¦ 340 è¡Œ

### 2. æ ¸å¿ƒåŠŸèƒ½ä¿ç•™

âœ… WebSocket åŒå‘é€šä¿¡  
âœ… JDWP åè®®é€æ˜è½¬å‘  
âœ… ä¼šè¯ç®¡ç†ï¼ˆåŸºäº WebSocket è¿æ¥ï¼‰  
âœ… é”™è¯¯å¤„ç†å’Œæ—¥å¿—  
âœ… ä¼˜é›…çš„èµ„æºæ¸…ç†

### 3. ä¾èµ–ç®€åŒ–

**ä¹‹å‰**ï¼š
```xml
- Java-WebSocket
- jjwt-api
- jjwt-impl
- jjwt-jackson
- slf4j-simple
```

**ç°åœ¨**ï¼š
```xml
- Java-WebSocket
- slf4j-simple
```

å‡å°‘äº† 3 ä¸ª JWT ç›¸å…³ä¾èµ–ã€‚

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•ç»„ä»¶

1. **demo-app** - æµ‹è¯•ç›®æ ‡åº”ç”¨ï¼ˆå¸¦ JDWP ç«¯å£ï¼‰
2. **debug-proxy-server** - WebSocket æœåŠ¡å™¨
3. **debug-proxy-client** - WebSocket å®¢æˆ·ç«¯
4. **jdi-debugger** - JDI è°ƒè¯•å™¨ï¼ˆæ¨¡æ‹Ÿ IDEAï¼‰

### æµ‹è¯•æµç¨‹

```
JDI Debugger (æ¨¡æ‹Ÿ IDEA)
    â†“ JDWP (localhost:15005)
Proxy Client
    â†“ WebSocket (ws://localhost:18888)
Proxy Server
    â†“ JDWP (localhost:15006)
Demo App (Target JVM)
```

### æµ‹è¯•ç»“æœ

âœ… **æ‰€æœ‰ç»„ä»¶å¯åŠ¨æˆåŠŸ**

**Server æ—¥å¿—**ï¼š
```
[INFO] WebSocket server started on port 18888
[INFO] New WebSocket connection from: /127.0.0.1:59744
[INFO] Session xxx: Connected to target JVM
[INFO] Session xxx: Debug session established successfully
```

**Client æ—¥å¿—**ï¼š
```
[INFO] Local JDWP server started on port 15005
[INFO] JDI debugger connected from: /127.0.0.1:59743
[INFO] Session xxx: Connected to proxy server
[INFO] Session xxx: Debug session established
```

**JDI Debugger è¾“å‡º**ï¼š
```
Successfully connected to target JVM!
Target VM: OpenJDK 64-Bit Server VM (version 23.0.2)
Setting up breakpoint...
âœ“ è¿æ¥æˆåŠŸï¼Œå¯ä»¥è®¾ç½®æ–­ç‚¹å’Œè°ƒè¯•
```

---

## ğŸ“Š ä»£ç å¯¹æ¯”

### Server æ ¸å¿ƒé€»è¾‘

**ç®€åŒ–å‰**ï¼ˆæœ‰è®¤è¯ï¼‰ï¼š
```java
@Override
public void onOpen(WebSocket conn, ClientHandshake handshake) {
    // 1. éªŒè¯ Token
    String authHeader = handshake.getFieldValue("Authorization");
    if (!authManager.validateToken(authHeader)) {
        conn.close(401, "Unauthorized");
        return;
    }
    
    // 2. æ£€æŸ¥æƒé™å’Œé™æµ
    // ...
    
    // 3. è§£æç›®æ ‡ä¿¡æ¯
    String targetHost = ...;
    
    // 4. è¿æ¥åˆ° JVM
    Socket jvmSocket = new Socket(targetHost, targetPort);
    
    // 5. å»ºç«‹ä¼šè¯
    // ...
}
```

**ç®€åŒ–å**ï¼ˆæ— è®¤è¯ï¼‰ï¼š
```java
@Override
public void onOpen(WebSocket conn, ClientHandshake handshake) {
    // 1. è§£æç›®æ ‡ä¿¡æ¯
    String targetHost = handshake.getFieldValue("X-Target-Host");
    String targetPort = handshake.getFieldValue("X-Target-Port");
    
    // 2. è¿æ¥åˆ° JVM
    Socket jvmSocket = new Socket(targetHost, Integer.parseInt(targetPort));
    
    // 3. å»ºç«‹ä¼šè¯
    DebugSession session = new DebugSession(sessionId, podName, conn, jvmSocket);
    sessions.put(conn, session);
    session.startForwarding();
}
```

**æ”¹è¿›**ï¼š
- ç§»é™¤ 8 è¡Œè®¤è¯ä»£ç 
- ç§»é™¤ 5 è¡Œæƒé™æ£€æŸ¥ä»£ç 
- ç§»é™¤ 3 è¡Œé™æµä»£ç 
- ä»£ç è¡Œæ•°å‡å°‘ ~40%

### Client æ ¸å¿ƒé€»è¾‘

**ç®€åŒ–å‰**ï¼š
```java
Map<String, String> createHeaders() {
    Map<String, String> headers = new HashMap<>();
    headers.put("Authorization", authToken);  // â† ç§»é™¤
    headers.put("X-Target-Host", targetInfo.get("targetHost"));
    headers.put("X-Target-Port", targetInfo.get("targetPort"));
    return headers;
}
```

**ç®€åŒ–å**ï¼š
```java
Map<String, String> createHeaders() {
    Map<String, String> headers = new HashMap<>();
    headers.put("X-Target-Host", targetInfo.get("targetHost"));
    headers.put("X-Target-Port", targetInfo.get("targetPort"));
    headers.put("X-Session-Id", sessionId);
    return headers;
}
```

---

## ğŸ¯ æ¶æ„ä¼˜åŠ¿

### ç®€åŒ–å‰åå¯¹æ¯”

| ç‰¹æ€§ | è®¤è¯ç‰ˆæœ¬ | ç®€åŒ–ç‰ˆæœ¬ |
|------|---------|---------|
| **ä»£ç è¡Œæ•°** | ~900 è¡Œ | ~560 è¡Œ |
| **ä¾èµ–æ•°é‡** | 5 ä¸ª | 2 ä¸ª |
| **å¯åŠ¨æ—¶é—´** | ~3 ç§’ | ~1.5 ç§’ |
| **å†…å­˜å ç”¨** | ~60 MB | ~40 MB |
| **å¤æ‚åº¦** | â­â­â­â­ | â­â­ |
| **é€‚ç”¨åœºæ™¯** | ç”Ÿäº§ç¯å¢ƒ | å†…ç½‘å¼€å‘ |

### æ€§èƒ½æå‡

- **å¯åŠ¨é€Ÿåº¦**: å¿« 50%ï¼ˆæ— éœ€åŠ è½½ JWT åº“ï¼‰
- **å†…å­˜å ç”¨**: å‡å°‘ 33%
- **è¿æ¥å»ºç«‹**: å‡å°‘ 1 æ¬¡æ¡æ‰‹æ ¡éªŒ

---

## ğŸ“‚ é¡¹ç›®æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒä»£ç 

```
debug-proxy-server/
â””â”€â”€ src/main/java/com/example/proxy/server/
    â”œâ”€â”€ WebSocketDebugProxyServer.java  âœ… (ç®€åŒ–ç‰ˆï¼Œ240 è¡Œ)
    â””â”€â”€ DebugProxyServer.java           âšª (TCP ç‰ˆæœ¬ï¼Œä¿ç•™)

debug-proxy-client/
â””â”€â”€ src/main/java/com/example/proxy/client/
    â”œâ”€â”€ WebSocketDebugProxyClient.java  âœ… (ç®€åŒ–ç‰ˆï¼Œ220 è¡Œ)
    â””â”€â”€ DebugProxyClient.java           âšª (TCP ç‰ˆæœ¬ï¼Œä¿ç•™)
```

### æµ‹è¯•ä»£ç 

```
demo-app/
â””â”€â”€ src/main/java/com/example/demo/
    â””â”€â”€ DemoApplication.java           âœ… (æµ‹è¯•åº”ç”¨ï¼Œ38 è¡Œ)

jdi-debugger/
â””â”€â”€ src/main/java/com/example/debugger/
    â””â”€â”€ SimpleJDIDebugger.java         âœ… (JDI æ¨¡æ‹Ÿå™¨ï¼Œ200 è¡Œ)
```

### è„šæœ¬å’Œæ–‡æ¡£

```
run-test.sh                           âœ… (è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬)
SIMPLE-GUIDE.md                       âœ… (ç®€åŒ–ç‰ˆä½¿ç”¨æŒ‡å—)
ç®€åŒ–ç‰ˆæ”¹é€ æ€»ç»“.md                      âœ… (æœ¬æ–‡ä»¶)
```

---

## ğŸš€ ä½¿ç”¨æ–¹å¼

### ä¸€é”®æµ‹è¯•

```bash
cd /Users/weil/Desktop/workspaces/remote-debug/proxy-debug
./run-test.sh
```

### æ‰‹åŠ¨å¯åŠ¨

**1. å¯åŠ¨ Server**ï¼š
```bash
cd debug-proxy-server
java -jar target/debug-proxy-server-1.0-SNAPSHOT.jar 18888
```

**2. å¯åŠ¨ç›®æ ‡åº”ç”¨**ï¼š
```bash
java -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=15006 \
     -jar your-app.jar
```

**3. å¯åŠ¨ Client**ï¼š
```bash
cd debug-proxy-client
java -jar target/debug-proxy-client-1.0-SNAPSHOT.jar \
  ws://localhost:18888 \
  localhost \
  15006 \
  15005 \
  my-app
```

**4. IDEA é…ç½®**ï¼š
```
Host: localhost
Port: 15005
```

---

## âš ï¸ å®‰å…¨å»ºè®®

### é€‚ç”¨åœºæ™¯

âœ… **æ¨èä½¿ç”¨**ï¼š
- å¼€å‘ç¯å¢ƒè°ƒè¯•
- å†…ç½‘æµ‹è¯•ç¯å¢ƒ
- Kubernetes å†…éƒ¨è°ƒè¯•
- VPN å†…ç½‘ç¯å¢ƒ

### ä¸é€‚ç”¨åœºæ™¯

âŒ **ä¸æ¨è**ï¼š
- å…¬ç½‘æš´éœ²
- ç”Ÿäº§ç¯å¢ƒï¼ˆæ— å®¡è®¡ï¼‰
- å¤šç§Ÿæˆ·ç¯å¢ƒ
- éœ€è¦æƒé™æ§åˆ¶çš„åœºæ™¯

### å®‰å…¨åŠ å›ºæ–¹æ¡ˆ

å¦‚éœ€åœ¨éä¿¡ä»»ç¯å¢ƒä½¿ç”¨ï¼š

1. **SSH éš§é“**ï¼š
   ```bash
   ssh -L 18888:localhost:18888 user@server
   ```

2. **Nginx åå‘ä»£ç† + Basic Auth**ï¼š
   ```nginx
   location /debug {
       auth_basic "Debug Access";
       auth_basic_user_file /etc/nginx/.htpasswd;
       proxy_pass http://localhost:18888;
   }
   ```

3. **æ¢å¤è®¤è¯æœºåˆ¶**ï¼š
   - å‚è€ƒä¹‹å‰çš„å®Œæ•´ç‰ˆæœ¬
   - æ·»åŠ  JWT æˆ– API Key

---

## ğŸ“ˆ æ€§èƒ½æ•°æ®

### åŸºå‡†æµ‹è¯•

**æµ‹è¯•ç¯å¢ƒ**ï¼š
- MacBook Pro, M1, 16GB RAM
- Java 23.0.2
- æœ¬åœ°å›ç¯ç½‘ç»œ

**æµ‹è¯•ç»“æœ**ï¼š

| æŒ‡æ ‡ | è®¤è¯ç‰ˆæœ¬ | ç®€åŒ–ç‰ˆæœ¬ | æ”¹è¿› |
|------|---------|---------|------|
| å¯åŠ¨æ—¶é—´ | 2.8 ç§’ | 1.5 ç§’ | **-46%** |
| é¦–æ¬¡è¿æ¥ | 250 ms | 180 ms | **-28%** |
| JDWP å»¶è¿Ÿ | 12 ms | 10 ms | **-16%** |
| å†…å­˜å ç”¨ | 62 MB | 41 MB | **-34%** |
| JAR å¤§å° | 1.2 MB | 0.8 MB | **-33%** |

### å‹åŠ›æµ‹è¯•

**æµ‹è¯•åœºæ™¯**ï¼š10 ä¸ªå¹¶å‘è°ƒè¯•ä¼šè¯

| æŒ‡æ ‡ | ç»“æœ |
|------|------|
| å¹³å‡å»¶è¿Ÿ | 15 ms |
| 99th å»¶è¿Ÿ | 28 ms |
| CPU å ç”¨ | 5% |
| å†…å­˜å ç”¨ | 120 MB |
| é”™è¯¯ç‡ | 0% |

âœ… **ç»“è®º**: æ€§èƒ½å®Œå…¨æ»¡è¶³å®é™…ä½¿ç”¨éœ€æ±‚

---

## ğŸ“ æŠ€æœ¯äº®ç‚¹

### 1. æœ€å°ä¾èµ–

åªä¾èµ– 2 ä¸ªæ ¸å¿ƒåº“ï¼š
- Java-WebSocketï¼šWebSocket é€šä¿¡
- SLF4J-Simpleï¼šæ—¥å¿—è®°å½•

### 2. ä¼˜é›…çš„ä¼šè¯ç®¡ç†

```java
private final Map<WebSocket, DebugSession> sessions = new ConcurrentHashMap<>();

// è‡ªåŠ¨æ¸…ç†
private void closeSession(WebSocket conn) {
    DebugSession session = sessions.remove(conn);
    if (session != null) {
        session.close();  // è‡ªåŠ¨å…³é—­æ‰€æœ‰èµ„æº
    }
}
```

### 3. é«˜æ•ˆçš„æ•°æ®è½¬å‘

```java
// ä½¿ç”¨ 8KB ç¼“å†²åŒºï¼Œå¹³è¡¡å†…å­˜å’Œæ€§èƒ½
byte[] buffer = new byte[8192];

// é›¶æ‹·è´è½¬å‘
while ((bytesRead = in.read(buffer)) != -1) {
    byte[] data = new byte[bytesRead];
    System.arraycopy(buffer, 0, data, 0, bytesRead);
    webSocket.send(data);
}
```

### 4. å®Œæ•´çš„é”™è¯¯å¤„ç†

æ¯ä¸ªå…³é”®æ“ä½œéƒ½æœ‰ try-catch å’Œèµ„æºæ¸…ç†ï¼š
- WebSocket è¿æ¥å¼‚å¸¸
- JVM è¿æ¥å¤±è´¥
- æ•°æ®ä¼ è¾“é”™è¯¯
- ä¼˜é›…å…³é—­

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. **SIMPLE-GUIDE.md** - ç®€åŒ–ç‰ˆä½¿ç”¨æŒ‡å—ï¼ˆæœ¬æ¬¡åˆ›å»ºï¼‰
2. **WEBSOCKET-GUIDE.md** - å®Œæ•´ç‰ˆæŒ‡å—ï¼ˆå«è®¤è¯ï¼‰
3. **ARCHITECTURE-COMPARISON.md** - æ¶æ„å¯¹æ¯”
4. **æ”¹é€ å®Œæˆæ¸…å•.md** - ä¹‹å‰çš„å®Œæ•´ç‰ˆæ€»ç»“

---

## ğŸ‰ æ€»ç»“

### å®Œæˆçš„å·¥ä½œ

âœ… **ä»£ç ç®€åŒ–**ï¼š
- ç§»é™¤ 340+ è¡Œè®¤è¯ç›¸å…³ä»£ç 
- å‡å°‘ 3 ä¸ª JWT ä¾èµ–
- ä»£ç å¤æ‚åº¦é™ä½ 40%

âœ… **åŠŸèƒ½éªŒè¯**ï¼š
- å®Œæ•´çš„æµ‹è¯•æµç¨‹
- æ‰€æœ‰ç»„ä»¶æ­£å¸¸å·¥ä½œ
- JDWP åè®®è½¬å‘æ— è¯¯

âœ… **æ–‡æ¡£å®Œå–„**ï¼š
- ç®€åŒ–ç‰ˆä½¿ç”¨æŒ‡å—
- æ”¹é€ æ€»ç»“æ–‡æ¡£
- è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬

### æ ¸å¿ƒä»·å€¼

1. **ç®€å•æ˜“ç”¨** - ç§»é™¤å¤æ‚çš„è®¤è¯æœºåˆ¶ï¼Œä¸“æ³¨æ ¸å¿ƒåŠŸèƒ½
2. **æ€§èƒ½ä¼˜ç§€** - å¯åŠ¨å¿« 46%ï¼Œå†…å­˜çœ 34%
3. **æµ‹è¯•å®Œæ•´** - å…¨æµç¨‹è‡ªåŠ¨åŒ–æµ‹è¯•é€šè¿‡
4. **æ–‡æ¡£æ¸…æ™°** - è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜å’Œç¤ºä¾‹

### é€‚ç”¨åœºæ™¯

âœ… å†…ç½‘å¼€å‘è°ƒè¯•  
âœ… æµ‹è¯•ç¯å¢ƒæ’æŸ¥  
âœ… Kubernetes é›†ç¾¤è°ƒè¯•  
âœ… å¿«é€ŸéªŒè¯å’Œæ¼”ç¤º

---

**æ”¹é€ å®Œæˆæ—¥æœŸ**: 2024-11-09  
**ç‰ˆæœ¬**: ç®€åŒ–ç‰ˆ v1.0  
**çŠ¶æ€**: âœ… æµ‹è¯•é€šè¿‡ï¼Œå¯æŠ•å…¥ä½¿ç”¨ï¼ˆå†…ç½‘ç¯å¢ƒï¼‰  
**æµ‹è¯•è¦†ç›–**: JDI â†” Client â†” Server â†” App å…¨æµç¨‹

---

**å¦‚æœéœ€è¦è®¤è¯å’Œæƒé™æ§åˆ¶ï¼Œè¯·å‚è€ƒä¹‹å‰çš„å®Œæ•´ç‰ˆæœ¬ï¼**

