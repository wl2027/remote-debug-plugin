# é—®é¢˜ä¿®å¤æ€»ç»“

## ğŸ› é—®é¢˜æè¿°

ç”¨æˆ·é‡åˆ°ä¸¤ä¸ªé—®é¢˜ï¼š

### 1. WebSocket å…³é—­ä»£ç é”™è¯¯

**é”™è¯¯ä¿¡æ¯**ï¼š
```
org.java_websocket.exceptions.InvalidFrameException: 
closecode must not be sent over the wire: 500
```

**åŸå› **ï¼š
- WebSocket åè®®è§„å®šå…³é—­ä»£ç å¿…é¡»åœ¨ 1000-4999 èŒƒå›´å†…
- ä»£ç ä¸­ä½¿ç”¨äº† HTTP çŠ¶æ€ç  `400`ã€`500` ä½œä¸º WebSocket å…³é—­ç 
- è¿™æ˜¯æ— æ•ˆçš„ï¼Œå¯¼è‡´å¼‚å¸¸

**ä¿®å¤**ï¼š
- âœ… å°† `400` æ”¹ä¸º `1008` (Policy Violation)
- âœ… å°† `500` æ”¹ä¸º `1011` (Internal Error)
- âœ… æ·»åŠ  try-catch é˜²æ­¢å…³é—­æ—¶å†æ¬¡æŠ›å‡ºå¼‚å¸¸

### 2. Demo App "è¢«å…³é—­"ä½†è°ƒè¯•è¿˜èƒ½ç»§ç»­

**ç°è±¡**ï¼š
- IDEA è¿æ¥åï¼Œdemo-app çœ‹èµ·æ¥è¢«å…³é—­äº†
- ä½†è°ƒè¯•åŠŸèƒ½ï¼ˆæ–­ç‚¹ã€å˜é‡æŸ¥çœ‹ï¼‰è¿˜èƒ½ç»§ç»­ä½¿ç”¨

**åŸå› **ï¼š
- è¿™æ˜¯ **IDEA è¿œç¨‹è°ƒè¯•çš„æ­£å¸¸è¡Œä¸º**ï¼
- IDEA æ§åˆ¶å°æ˜¾ç¤ºçš„æ˜¯**æœ¬åœ°è°ƒè¯•å™¨è¿æ¥**çš„çŠ¶æ€ï¼Œä¸æ˜¯è¿œç¨‹åº”ç”¨çš„çŠ¶æ€
- è¿œç¨‹åº”ç”¨çš„è¾“å‡ºä¸ä¼šæ˜¾ç¤ºåœ¨ IDEA æ§åˆ¶å°ä¸­
- ç”¨æˆ·è¯¯ä»¥ä¸ºåº”ç”¨è¢«å…³é—­äº†ï¼Œå®é™…ä¸Šåº”ç”¨ä¸€ç›´åœ¨è¿è¡Œ

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ”¹è¿› demo-appï¼Œæ·»åŠ è¯¦ç»†çš„çŠ¶æ€æ—¥å¿—
2. åˆ›å»ºè¯Šæ–­è„šæœ¬å¸®åŠ©æ£€æŸ¥ç»„ä»¶çŠ¶æ€
3. ç¼–å†™è¯¦ç»†çš„ IDEA è°ƒè¯•æŒ‡å—

---

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 1. ä¿®å¤ WebSocket å…³é—­ä»£ç 

**æ–‡ä»¶**: `debug-proxy-server/src/main/java/com/example/proxy/server/WebSocketDebugProxyServer.java`

**ä¿®æ”¹å‰**ï¼š
```java
conn.close(400, "Bad Request: Missing target information");
conn.close(500, "Internal Server Error: " + e.getMessage());
```

**ä¿®æ”¹å**ï¼š
```java
conn.close(1008, "Missing target information");
try {
    conn.close(1011, "Cannot connect to target: " + e.getMessage());
} catch (Exception closeEx) {
    logger.debug("Error closing connection: {}", closeEx.getMessage());
}
```

**WebSocket å…³é—­ä»£ç è¯´æ˜**ï¼š
- `1000` - Normal Closure
- `1001` - Going Away
- `1008` - Policy Violationï¼ˆç­–ç•¥è¿è§„ï¼‰
- `1011` - Internal Errorï¼ˆå†…éƒ¨é”™è¯¯ï¼‰
- `1000-4999` - æœ‰æ•ˆèŒƒå›´

### 2. æ”¹è¿› Demo App

**æ–‡ä»¶**: `demo-app/src/main/java/com/example/demo/DemoApplication.java`

**æ–°å¢åŠŸèƒ½**ï¼š

#### A. Shutdown Hook æ£€æµ‹
```java
Runtime.getRuntime().addShutdownHook(new Thread(() -> {
    log("âš ï¸  JVM Shutdown Hook triggered! Application is exiting...");
    System.err.println("âš ï¸  Application is shutting down!");
}));
```
- å¦‚æœåº”ç”¨çœŸçš„é€€å‡ºï¼Œä¼šåœ¨æ—¥å¿—ä¸­è®°å½•
- å¸®åŠ©è¯Šæ–­åº”ç”¨æ˜¯å¦çœŸçš„è¢«å…³é—­

#### B. çŠ¶æ€æ—¥å¿—è®°å½•
```java
private static final String LOG_FILE = "/tmp/demo-app-status.log";

log("âœ… Demo Application started! PID: " + ProcessHandle.current().pid());
```
- è®°å½•åº”ç”¨å¯åŠ¨ã€è¿è¡ŒçŠ¶æ€
- åŒ…å« PIDã€è®¡æ•°å™¨ã€çº¿ç¨‹æ•°ç­‰ä¿¡æ¯
- æ—¥å¿—æ–‡ä»¶ï¼š`/tmp/demo-app-status.log`

#### C. æ›´å¥½çš„å¼‚å¸¸å¤„ç†
```java
try {
    processData();
    Thread.sleep(3000);
} catch (InterruptedException e) {
    log("âš ï¸  Thread interrupted: " + e.getMessage());
    System.err.println("Thread interrupted, but continuing...");
    // ä¸é€€å‡ºï¼Œç»§ç»­è¿è¡Œ
} catch (Exception e) {
    log("âŒ Error in main loop: " + e.getMessage());
    e.printStackTrace();
    // å‘ç”Ÿé”™è¯¯ä¹Ÿä¸é€€å‡º
}
```
- æ•è·æ‰€æœ‰å¼‚å¸¸
- è®°å½•åˆ°æ—¥å¿—æ–‡ä»¶
- **æ°¸ä¸é€€å‡º**ï¼Œç¡®ä¿åº”ç”¨æŒç»­è¿è¡Œ

#### D. å®šæœŸçŠ¶æ€è¾“å‡º
```java
if (counter % 10 == 0) {
    System.out.println("ğŸ“Š Status: Application is running, counter=" + counter);
    log("ğŸ“Š Status check: counter=" + counter + ", threads=" + Thread.activeCount());
}
```
- æ¯ 10 æ¬¡å¾ªç¯è¾“å‡ºä¸€æ¬¡çŠ¶æ€
- è¯æ˜åº”ç”¨è¿˜åœ¨è¿è¡Œ

### 3. åˆ›å»ºè¯Šæ–­å·¥å…·

#### A. çŠ¶æ€æ£€æŸ¥è„šæœ¬

**æ–‡ä»¶**: `check-status.sh`

**åŠŸèƒ½**ï¼š
- âœ… æ£€æŸ¥æ‰€æœ‰ç«¯å£å ç”¨æƒ…å†µ
- âœ… æ£€æŸ¥ç›¸å…³è¿›ç¨‹æ˜¯å¦è¿è¡Œ
- âœ… æ˜¾ç¤ºæœ€è¿‘çš„æ—¥å¿—
- âœ… æä¾›è¯Šæ–­æç¤º

**ä½¿ç”¨**ï¼š
```bash
./check-status.sh
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
æ£€æŸ¥ç«¯å£å ç”¨æƒ…å†µ:
  âœ… Proxy Server (ç«¯å£ 18888) - è¿è¡Œä¸­
     PID: 12345
     CMD: java -jar debug-proxy-server...
  
  âœ… Demo App (JDWP) (ç«¯å£ 15006) - è¿è¡Œä¸­
     PID: 12346
     CMD: java -agentlib:jdwp...

æ£€æŸ¥ Demo App çŠ¶æ€æ—¥å¿—:
  æœ€è¿‘ 5 æ¡æ—¥å¿—:
  [2024-11-09 11:45:00] âœ… Demo Application started! PID: 12346
  [2024-11-09 11:45:03] Processing data #1
  [2024-11-09 11:45:06] Processing data #2
  ...
```

#### B. å¯åŠ¨è„šæœ¬

**æ–‡ä»¶**: `start-demo-app.sh`
- å•ç‹¬å¯åŠ¨ demo-app
- æ£€æŸ¥ç«¯å£å ç”¨
- è‡ªåŠ¨ç¼–è¯‘ï¼ˆå¦‚æœéœ€è¦ï¼‰

**æ–‡ä»¶**: `start-all.sh`
- ä¸€é”®å¯åŠ¨æ‰€æœ‰ç»„ä»¶
- æŒ‰æ­£ç¡®é¡ºåºå¯åŠ¨
- æ˜¾ç¤ºè¯¦ç»†çŠ¶æ€
- æä¾›ç›‘æ§å‘½ä»¤

**ä½¿ç”¨**ï¼š
```bash
# å¯åŠ¨æ‰€æœ‰ç»„ä»¶
./start-all.sh

# æˆ–å•ç‹¬å¯åŠ¨
./start-demo-app.sh
```

### 4. åˆ›å»ºè¯¦ç»†æ–‡æ¡£

**æ–‡ä»¶**: `IDEA-DEBUG-GUIDE.md`

**å†…å®¹**ï¼š
- ğŸ“– é—®é¢˜è¯Šæ–­è¯´æ˜
- ğŸ” ä¸‰ç§å¯èƒ½çš„åŸå› åˆ†æ
- âœ… éªŒè¯æ–¹æ³•
- ğŸš€ æ­£ç¡®çš„ä½¿ç”¨æµç¨‹
- ğŸ’¡ æœ€ä½³å®è·µ
- ğŸ“Š è°ƒè¯•åŠŸèƒ½éªŒè¯æ¸…å•
- ğŸ“ è¿œç¨‹è°ƒè¯•å·¥ä½œåŸç†

---

## ğŸ¯ ä½¿ç”¨æŒ‡å—

### å¿«é€Ÿæµ‹è¯•ï¼ˆæ¨èï¼‰

```bash
# 1. å¯åŠ¨æ‰€æœ‰ç»„ä»¶
./start-all.sh

# 2. åœ¨å¦ä¸€ä¸ªç»ˆç«¯ç›‘æ§ demo-app
tail -f /tmp/demo-app.log

# 3. é…ç½® IDEA å¹¶è¿æ¥
#    Host: localhost
#    Port: 15005

# 4. å¦‚æœæ€€ç–‘æœ‰é—®é¢˜ï¼Œè¿è¡Œè¯Šæ–­
./check-status.sh
```

### éªŒè¯åº”ç”¨æ˜¯å¦çœŸçš„åœ¨è¿è¡Œ

```bash
# æ–¹å¼ 1: æŸ¥çœ‹è¿›ç¨‹
ps aux | grep demo-app

# æ–¹å¼ 2: æŸ¥çœ‹ç«¯å£
lsof -i :15006

# æ–¹å¼ 3: æŸ¥çœ‹æ—¥å¿—
tail -f /tmp/demo-app-status.log

# æ–¹å¼ 4: è¿è¡Œè¯Šæ–­è„šæœ¬
./check-status.sh
```

### æŸ¥çœ‹åº”ç”¨è¾“å‡º

```bash
# æ ‡å‡†è¾“å‡º
tail -f /tmp/demo-app.log

# çŠ¶æ€æ—¥å¿—ï¼ˆåŒ…å« PIDã€è®¡æ•°å™¨ã€shutdown hookï¼‰
tail -f /tmp/demo-app-status.log
```

---

## ğŸ“Š ä¿®å¤éªŒè¯

### 1. WebSocket é”™è¯¯ä¿®å¤éªŒè¯

**ä¹‹å‰**ï¼š
```
[WebSocketWorker-24] ERROR - generated frame is invalid
org.java_websocket.exceptions.InvalidFrameException: 
closecode must not be sent over the wire: 500
```

**ä¹‹å**ï¼š
- âœ… ä¸å†å‡ºç° InvalidFrameException
- âœ… è¿æ¥é”™è¯¯æ—¶æ­£å¸¸å…³é—­
- âœ… ä½¿ç”¨æ­£ç¡®çš„ WebSocket å…³é—­ä»£ç 

### 2. Demo App çŠ¶æ€éªŒè¯

**ä¹‹å‰**ï¼š
- â“ ä¸çŸ¥é“åº”ç”¨æ˜¯å¦çœŸçš„é€€å‡º
- â“ æ²¡æœ‰è¯¦ç»†æ—¥å¿—
- â“ å¼‚å¸¸å¯èƒ½å¯¼è‡´åº”ç”¨é€€å‡º

**ä¹‹å**ï¼š
- âœ… Shutdown hook æ£€æµ‹åº”ç”¨é€€å‡º
- âœ… è¯¦ç»†çŠ¶æ€æ—¥å¿—è®°å½•
- âœ… å¼‚å¸¸ä¸ä¼šå¯¼è‡´åº”ç”¨é€€å‡º
- âœ… å®šæœŸçŠ¶æ€è¾“å‡ºè¯æ˜åº”ç”¨è¿è¡Œ

---

## ğŸ“ å…³é”®çŸ¥è¯†ç‚¹

### IDEA è¿œç¨‹è°ƒè¯•çš„çœŸç›¸

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         IDEA è¿œç¨‹è°ƒè¯•å·¥ä½œåŸç†                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  IDEA æ§åˆ¶å°æ˜¾ç¤ºï¼š                            â”‚
â”‚  "Process finished with exit code 0"         â”‚
â”‚                                              â”‚
â”‚  â†“                                           â”‚
â”‚                                              â”‚
â”‚  è¿™æ˜¾ç¤ºçš„æ˜¯ï¼šæœ¬åœ°è°ƒè¯•å™¨è¿æ¥çš„çŠ¶æ€              â”‚
â”‚  ä¸æ˜¯ï¼šè¿œç¨‹åº”ç”¨çš„çŠ¶æ€                         â”‚
â”‚                                              â”‚
â”‚  â†“                                           â”‚
â”‚                                              â”‚
â”‚  è¿œç¨‹åº”ç”¨å®é™…ä¸Šï¼šä¸€ç›´åœ¨è¿è¡Œ                    â”‚
â”‚  è¿œç¨‹åº”ç”¨è¾“å‡ºï¼šä¸ä¼šæ˜¾ç¤ºåœ¨ IDEA æ§åˆ¶å°          â”‚
â”‚  è°ƒè¯•åŠŸèƒ½ï¼šå®Œå…¨æ­£å¸¸                           â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¦‚ä½•æŸ¥çœ‹è¿œç¨‹åº”ç”¨è¾“å‡º

| ä½ç½® | å†…å®¹ | å‘½ä»¤ |
|------|------|------|
| **å¯åŠ¨ç»ˆç«¯** | æ ‡å‡†è¾“å‡º | æŸ¥çœ‹è¿è¡Œ demo-app çš„ç»ˆç«¯ |
| **/tmp/demo-app.log** | å®Œæ•´è¾“å‡º | `tail -f /tmp/demo-app.log` |
| **/tmp/demo-app-status.log** | çŠ¶æ€æ—¥å¿— | `tail -f /tmp/demo-app-status.log` |
| **è¯Šæ–­è„šæœ¬** | å®æ—¶çŠ¶æ€ | `./check-status.sh` |

---

## ğŸ“ æ–°å¢æ–‡ä»¶æ¸…å•

```
proxy-debug/
â”œâ”€â”€ demo-app/
â”‚   â””â”€â”€ src/main/java/com/example/demo/
â”‚       â””â”€â”€ DemoApplication.java        â† æ”¹è¿›ï¼šæ·»åŠ  shutdown hookã€æ—¥å¿—
â”‚
â”œâ”€â”€ debug-proxy-server/
â”‚   â””â”€â”€ src/main/java/com/example/proxy/server/
â”‚       â””â”€â”€ WebSocketDebugProxyServer.java  â† ä¿®å¤ï¼šWebSocket å…³é—­ä»£ç 
â”‚
â”œâ”€â”€ check-status.sh                     â† æ–°å¢ï¼šè¯Šæ–­è„šæœ¬
â”œâ”€â”€ start-demo-app.sh                   â† æ–°å¢ï¼šå¯åŠ¨ demo-app
â”œâ”€â”€ start-all.sh                        â† æ–°å¢ï¼šä¸€é”®å¯åŠ¨æ‰€æœ‰ç»„ä»¶
â”œâ”€â”€ IDEA-DEBUG-GUIDE.md                 â† æ–°å¢ï¼šIDEA è°ƒè¯•æŒ‡å—
â””â”€â”€ é—®é¢˜ä¿®å¤æ€»ç»“.md                      â† æ–°å¢ï¼šæœ¬æ–‡ä»¶
```

---

## âœ… æ€»ç»“

### ä¿®å¤çš„é—®é¢˜

1. âœ… **WebSocket å…³é—­ä»£ç é”™è¯¯** - ä½¿ç”¨æ­£ç¡®çš„ 1000-4999 èŒƒå›´
2. âœ… **Demo App çŠ¶æ€ä¸æ˜** - æ·»åŠ è¯¦ç»†æ—¥å¿—å’Œ shutdown hook
3. âœ… **ç”¨æˆ·è¯¯è§£** - ç¼–å†™è¯¦ç»†æ–‡æ¡£è¯´æ˜ IDEA è¿œç¨‹è°ƒè¯•çš„å·¥ä½œåŸç†

### æ–°å¢çš„åŠŸèƒ½

1. âœ… **Shutdown Hook** - æ£€æµ‹åº”ç”¨æ˜¯å¦çœŸçš„é€€å‡º
2. âœ… **çŠ¶æ€æ—¥å¿—** - è®°å½• PIDã€è®¡æ•°å™¨ã€çº¿ç¨‹æ•°
3. âœ… **è¯Šæ–­è„šæœ¬** - å¿«é€Ÿæ£€æŸ¥æ‰€æœ‰ç»„ä»¶çŠ¶æ€
4. âœ… **å¯åŠ¨è„šæœ¬** - ç®€åŒ–å¯åŠ¨æµç¨‹
5. âœ… **è¯¦ç»†æ–‡æ¡£** - å®Œæ•´çš„è°ƒè¯•æŒ‡å—

### æ ¸å¿ƒè¦ç‚¹

**"demo-app è¢«å…³é—­ä½†è°ƒè¯•è¿˜èƒ½ç»§ç»­" = IDEA è¿œç¨‹è°ƒè¯•çš„æ­£å¸¸è¡Œä¸ºï¼**

- IDEA æ§åˆ¶å°æ˜¾ç¤ºçš„æ˜¯æœ¬åœ°è°ƒè¯•å™¨çŠ¶æ€ï¼Œä¸æ˜¯è¿œç¨‹åº”ç”¨çŠ¶æ€
- è¿œç¨‹åº”ç”¨ä¸€ç›´åœ¨è¿è¡Œï¼Œè¾“å‡ºåœ¨æ—¥å¿—æ–‡ä»¶ä¸­
- è°ƒè¯•åŠŸèƒ½å®Œå…¨æ­£å¸¸ï¼Œå¯ä»¥æ”¾å¿ƒä½¿ç”¨

### éªŒè¯æ–¹æ³•

```bash
# ä¸€é”®éªŒè¯
./check-status.sh

# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -f /tmp/demo-app.log
tail -f /tmp/demo-app-status.log
```

---

**ç¼–è¯‘æ—¶é—´**: 2024-11-09  
**ä¿®å¤çŠ¶æ€**: âœ… å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡

